version: 2.1

# 定义缓存规则：加速构建，避免重复安装依赖
commands:
  restore_python_deps:
    steps:
      - restore_cache:
          keys:
            - python-deps-{{ checksum "requirements.txt" }}
            - python-deps-
  save_python_deps:
    steps:
      - save_cache:
          key: python-deps-{{ checksum "requirements.txt" }}
          paths:
            - venv/

jobs:
  # 构建任务：预处理+生成视频+质量校验
  build_video:
    docker:
      - image: cimg/python:3.11  # 基础镜像（含Python，自动安装FFmpeg/Node.js）
    working_directory: ~/project
    steps:
      - checkout
      - restore_python_deps
      # 安装系统依赖：FFmpeg（视频处理）、nodejs（Edge TTS依赖）
      - run:
          name: 安装系统依赖
          command: |
            sudo apt-get update && sudo apt-get install -y ffmpeg nodejs npm
            npm install -g edge-tts  # 安装免费TTS工具
      # 安装Python依赖
      - run:
          name: 安装Python依赖
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
      - save_python_deps
      # 图片预处理：裁剪为9:16，统一1080×1920
      - run:
          name: 图片预处理
          command: |
            . venv/bin/activate
            python scripts/preprocess.py
      # 生成短视频：合成视频+TTS音频+音视频融合
      - run:
          name: 生成漫画解说短视频
          command: |
            . venv/bin/activate
            python scripts/generate_video.py
      # 视频质量校验：失败则终止流水线
      - run:
          name: 视频质量校验
          command: |
            . venv/bin/activate
            python scripts/validate_video.py
      # 保存生成的视频到工作区，供部署任务使用
      - persist_to_workspace:
          root: ~/project
          paths:
            - output/

  # 部署任务：将视频上传到AWS S3（公网可访问）
  deploy_to_s3:
    docker:
      - image: cimg/aws:2024.01  # 含AWS CLI的镜像
    working_directory: ~/project
    steps:
      - attach_workspace:
          at: ~/project  # 加载构建任务的工作区（获取output目录）
      - run:
          name: 配置AWS CLI并上传视频
          command: |
            # 配置AWS密钥（通过CircleCI环境变量注入，避免硬编码）
            aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
            aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
            aws configure set region $AWS_REGION
            # 同步output目录到S3桶，设置公网可读
            aws s3 sync output/ s3://$S3_BUCKET_NAME/manga-video/ --acl public-read
            # 打印视频访问地址
            echo "视频上传成功，访问地址：https://$S3_BUCKET_NAME.s3.$AWS_REGION.amazonaws.com/manga-video/final_video.mp4"

# 定义流水线：先构建，构建成功后再部署（仅main分支触发）
workflows:
  manga-video-automation:
    jobs:
      - build_video:
          filters:
            branches:
              only: main
      - deploy_to_s3:
          requires:
            - build_video  # 依赖构建任务成功
          filters:
            branches:
              only: main
